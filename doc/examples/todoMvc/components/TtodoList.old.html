<html>        
<head>

<link rel="stylesheet/less" type="text/less" href="./TtodoList.less"/>

<script type="text/x-class-definition">
//<![CDATA[

defineClass("TtodoList", "core.display.Telement", { 

	/* PROPRIETES */
	baseElement: "section",	
	_liste:null,
	_filter: "",

	 // METHODES 
	constructor: function(args){ 
		this._super.constructor.call(this,args);
		this._setEvents();		
	},

	setListe: function(liste)
	{
		this._liste = liste;
		this._liste.on(Tevent.CHANGE, this._onListeChanged, this);
		this._liste.on(Tevent.UPDATE, this._onListeChanged, this);		
		this.refresh();
	},

	clear: function()
	{
		this.todoList.html("");
	},

	refresh: function()
	{
		this.clear(); 
		var completedCount = 0;
		if (this._liste == null) return;

		for (var i=0; i<this._liste.length; i++)
		{
			var item = this._liste.getItemAt(i);
			var f = (this._filter == "") || ((this._filter == "completed") && (item.completed == true)) || ((this._filter == "active") && (item.completed == false));

			if (f == true)
			this._addItem(item);

			if (item.completed === true)
				completedCount ++;
		}
		var itemsLeft = this._liste.length - completedCount;

		this.buttonClearCompleted.text( 'Clear completed ('+completedCount+')' );
		this.todoCount.html('<strong>'+itemsLeft+'</strong> items left');

		if (itemsLeft == 0)
			this.toggleAll.prop('checked', true);
		else
			this.toggleAll.prop("checked", false)			
	},

	_onGetSuccess: function(data)
	{		
	},

	hide: function()
	{		
		this._super.hide.call(this);
	},

	_onShow: function()
	{	  
		this.refresh();	
	},
	
	_setEvents: function()
	{
		this.buttonClearCompleted.on("click", this.onClearCompletedClick.bind(this));
		this.buttonAllSelected.on("click", this.onbuttonFilterClick.bind(this));
		this.buttonActiveSelected.on("click", this.onbuttonFilterClick.bind(this));
		this.buttonCompletedSelected.on("click", this.onbuttonFilterClick.bind(this));	
		this.toggleAll.on("click", this._ontoggleAllClick.bind(this));	
		this.newTodo.on("keypress", this._onnewTodokeypress.bind(this));	
	},

	_setFilter: function(f)
	{
		this.buttonAllSelected.removeClass("selected");
		this.buttonActiveSelected.removeClass("selected");
		this.buttonCompletedSelected.removeClass("selected");	
		this._filter = f;

		if (f == "")
			this.buttonAllSelected.addClass("selected");
		if (f == "active")
			this.buttonActiveSelected.addClass("selected");
		if (f == "completed")
			this.buttonCompletedSelected.addClass("selected");

		this.refresh();
	},

	_onListeChanged: function(evt)
	{
		this.refresh();
	},

	onClearCompletedClick: function(evt)
	{
		var idList = [];
		for (var i=0; i< this._liste.length; i++){
			var item = this._liste.getItemAt(i);
			if (item.completed == true)
				idList.push(item.id);
		}
		panjs.controller.remove(idList);
	},

	onbuttonFilterClick: function(evt)
	{
		this._setFilter($(evt.target).attr("href").droite("/"));
	},

	_onnewTodokeypress: function(evt)
	{
		if(evt.keyCode==13){
			var newItem = {};
			newItem.id = 0;
			newItem.completed = false;
			newItem.texte = $(evt.target).val();
			panjs.controller.saveOrUpdate(newItem, function(data){
				$(evt.target).val("");
			});
		}
	},

	_onDestroyClick: function(evt)
	{
		var id = $(evt.target).parent().parent().attr("itemId");
		panjs.controller.remove([id]);
	},

	_onCkeckedClick: function(evt)
	{
		var checked = $(evt.target).is(':checked');		
		var id = $(evt.target).parent().parent().attr("itemId");
		panjs.controller.setItemCompleted(id, checked);
	},
	_onEditItemClick: function(evt)
	{
		var li = $(evt.target).parent().parent();
		var edit = li.getElement(".edit");
		li.addClass("editing");
		edit.focus();
	},

	_onEditItemFocusOut: function(evt)
	{
		this._validateModif(evt);
	},

	_onEditItemKeypress: function(evt)
	{	
		if(evt.keyCode==13){
			this._validateModif(evt);
		}
	},

	_validateModif:function(evt)
	{
		var li = $(evt.target).parent();
		var edit = li.getElement(".edit");
		id = li.attr("itemId");

		var item = this._liste.getByProp("id", id);
		item.texte = edit.val();
		panjs.controller.saveOrUpdate(item);
		li.removeClass("editing");
	},

	_ontoggleAllClick: function(evt)
	{	
		var checked = $(evt.target).is(':checked');
		for (var i=0; i< this._liste.length; i++){
			var item = this._liste.getItemAt(i);
			panjs.controller.setItemCompleted(item.id, checked);
		}
	},
	
	_addItem: function(item, insert)
	{
		var h = '';

		h += '<li class="completed" itemId="'+item.id+'">';
		h += '			<div class="view">';
		h += '				<input class="toggle" type="checkbox" checked=""/>';
		h += '				<label>'+item.texte+'</label>';
		h += '				<button class="destroy"></button>';
		h += '			</div>';
		h += '			<input class="edit" value="'+item.texte+'"/>';
		h += '</li>';

		h = $(h);

		h.getElement(".destroy").on("click", this._onDestroyClick.bind(this));
		h.getElement(".view").on("dblclick", this._onEditItemClick.bind(this));
		h.getElement("input:checked").on("click", this._onCkeckedClick.bind(this));
		h.getElement(".edit").on("blur", this._onEditItemFocusOut.bind(this));
		h.getElement(".edit").on("keypress", this._onEditItemKeypress.bind(this));

		if (!item.completed)
		{
			h.removeClass("completed");
			h.getElement("input:checked").removeAttr("checked");
		}

		if (insert === true)
			this.todoList.prepend(h);
		else
			this.todoList.append(h);
	}
});

//]]>
</script>

</head>

<body>	
	
		<header id="header" class="header">
			<h1>todos</h1>
			<input class="newTodo" id="newTodo" placeholder="What needs to be done?" autofocus="" />
		</header>
		<section id="main" class="main">
			<input id="toggleAll" class="toggleAll" type="checkbox"/>
			<label for="toggleAll">Mark all as complete</label>
			<ul id="todoList" class="todo-list">
				<!--
				ICI Les <LI> correspondant aux éléments de la liste
				-->
			</ul>
		</section>

		<footer id="footer" class="footer">
			<span id="todoCount" class="todoCount">
				<strong>3</strong> items left
			</span>
			<ul id="filters" class="filters">
				<li>
					<a id="buttonAllSelected" class="selected" href="#!/">All</a>
				</li>
				<li>
					<a id="buttonActiveSelected" href="#!/active" class="">Active</a>
				</li>
				<li>
					<a id="buttonCompletedSelected"  href="#!/completed" class="">Completed</a>
				</li>
			</ul>

			<button id="buttonClearCompleted" class="clearCompleted">Clear completed (4)</button>

		</footer>		


</body>
</html> 
