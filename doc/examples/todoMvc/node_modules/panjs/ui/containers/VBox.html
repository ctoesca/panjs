<html>        
<head>

<style>
*{
	box-sizing: border-box;
}
.VBox{
	/*border-style:solid;
	border-width: 1px;
	background-color:#aaaaaa;
	overflow-y: auto;
	padding:5px;
	*/
	width:100%;
		
	/*min-height: 20px; Quand cette taille est atteinte, height passe Ã  cette valeur et le div prend cette taille fixe */
}
[data-class]{
	/*border-style:solid;
	border-width:1px;*/
}

.VBox{
	overflow-y: auto;
	overflow-x: auto;
}

body{
	margin: 0px;
}
</style>
<script data-subtype="text/x-class-definition">
//<![CDATA[
uses("panjs.core.helpers.Ttimer");

defineClass("VBox", "panjs.core.display.Telement", { 

	baseElement: "div",	
	height: null,
	$percentHeight: null,
	lastbodyheight: null,
	timer: null,


	constructor: function(args){ 
		this._super.constructor.call(this,args);

		this.content.css("height", "100%");
		if (defined(args, "height")){
			this.setHeight(args.height);
		}

		//this.container.css("background-color", '#'+Math.floor(Math.random()*16777215).toString(16));

		$(window).resize( this.onWindowResize.bind(this));

		this.timer = new Ttimer({delay:50});
		this.timer.on(Ttimer.ON_TIMER, this.onTimer.bind(this));
		this.timer.start();
      
	},
	onTimer: function(e){
		var bodyheight = this.getNewBodyHeight();
		if (bodyheight > 0)
		{
			this.timer.stop();
			this.onWindowResize();
			//logger.debug("margin-bottom = "+this.container.css("margin-bottom")+", marginTop="+this.container.css("margin-top"));
		}
		//this.setBodyHeight(bodyheight);
	},

	addChild: function(el){
		this.content.append(el);
	},
	removeChild: function(el){
		this.content.remove(el);
	},
	setBodyHeight: function(v){
		if (this.lastbodyheight != v)
		{
			this.lastbodyheight = v;
			this.body.css("height", v+"px");
		}
	},

	getNewBodyHeight: function(){
				
		var containerheight = this.container.height();	
		
		var bodyheight = containerheight;

		//logger.debug("containerheight="+containerheight+", bodyheight="+bodyheight);
		return bodyheight;
	},
	calcFixedHeight: function(){
		var elements = this.content[0].children;
		var r = 0;
		for (var i=0; i< elements.length; i++){
			if (elements[i].nodeType == 1){
				var el = $(elements[i]);
				var isFixedHeight =  (el.attr("height").endsWith("px"));
				
				if (isFixedHeight){

					//var isFixedHeight = cssHeight.endsWith("px");

					//logger.debug( el.attr("id")+" -> calcFixedHeight cssHeight = "+cssHeight+" isFixedHeight="+isFixedHeight);

					//if (isFixedHeight)
					logger.debug("Height = "+el.height());
					r += parseInt( el.height() );	
				}
				
			}
			
		}
		return r;
	},
	onWindowResize: function(e){	
		logger.debug( "calcFixedHeight = "+this.calcFixedHeight() );
		var bodyheight = this.getNewBodyHeight()- this.calcFixedHeight();

		//update height des sous composants
		var elements = this.content[0].children;
		for (var i=0; i< elements.length; i++){
			if (elements[i].nodeType == 1){
				var el = $(elements[i]);
				var cssHeight =  el.attr("height");
				if (cssHeight != null){
					var isPercentHeight = cssHeight.endsWith("%");
					if (isPercentHeight)
					{
						var top = parseInt( el.css("margin-top").leftOf("px") );
						var newHeight = (bodyheight*parseFloat(cssHeight.leftOf('%')))/100 -top;
						logger.debug("top = "+top+", newHeight = "+newHeight);
				    	el.css("height", newHeight+"px");
					}
				}
			}
		}


		//this.setBodyHeight(bodyheight);
	},
	setHeight: function(v){
		//v in %
		this.container.attr("height", v);
		this.container.css("height", v);
		this.height = v;
		if (v.endsWith("%"))
			this.percentHeight = parseInt(v.leftOf("%"));
		else
			this.percentHeight = null;
		this.onWindowResize();
	}
	
});

//]]>
</script>

</head>

<body>	
	
	<div id="body" style="height:100%"> 
		<!--CONTENT-->
	</div>
	
</body>
</html> 
