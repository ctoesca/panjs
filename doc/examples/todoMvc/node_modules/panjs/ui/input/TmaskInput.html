<html>        
<head>

<script src="../../lib/opentip/2.4.6/downloads/opentip-jquery.min.js"></script>
<link href="../../lib/opentip/2.4.6/css/opentip.css" rel="stylesheet" type="text/css" />

<style type="text/less">	

.TmaskInput
{
	vertical-align: middle;
}
.TmaskInput.error{
		color:#c9302c;
		border-color:#c9302c;
		border-width: 1px;
	}
</style>

<script data-subtype="text/x-class-definition">
//<![CDATA[
              
defineClass("TmaskInput", "panjs.core.display.Telement", { 

	baseElement: "input",
	errorText: null,
	mask: /.*/,
	placeholder: "",
	required: false,
	size: null,
	_oldValue: null, 
	inputOpentip: null,

	constructor: function(args){
		
		this._super.constructor.call(this,args);
		
		this.input = this.container;

		if (args)
		{
			this.injectParam("placeholder", args.placeholder,false, this.placeholder);
			this.injectParam("required", args.required,false);
			this.injectParam("size", args.size,false);
			if (args.mask)
				this.mask = new RegExp(args.mask);	
		}
				
		if (this.size)
		{
			this.container.attr("size", this.size);
			this.container.css("width", (this.size*25)+"px")
			//this.input.attr("maxLength", args.elem.getAttribute("size")); // ne fonctionne que sur input type="text"
		}

		this.container.attr("type","text");
		this.container.addClass("form-control");
		this.setPlaceholder( this.placeholder );

		var v = "";
		if (defined(args, "value"))
			v = args.value;
		this.val(v);
		this._setEvents();
	
	},
	setPlaceholder: function(v){
		this.container.attr("placeholder", v);
	},
	free: function(){
		this._super.free.call(this);
		if (this.inputOpentip){
			this.inputOpentip.deactivate();
		}
	},
	enabled: function(v){
		if (v)
			this.container.removeAttr("disabled");
		else
			this.container.attr("disabled","disabled");
		
	},
	_setEvents: function()
	{
		this.container.on("change", this._onChange.bind(this));
		this.container.on("keyup", this._onKeyUp.bind(this));
		this.container.on("keydown", this._onKeyDown.bind(this));
		this.container.on("focusout", this._onFocusOut.bind(this));
	},
	_onKeyUp: function(e){
		this._onChange(e);
	},
	_onKeyDown:function(e)
	{
		var evt = new Tevent(Tevent.KEYDOWN, {evt: e});
		this.dispatchEvent( evt );
		if (!evt.defaultPrevented)
		{
			if (!this._isCharAccepted(e))
				e.preventDefault();	
		}
	},

	_onFocusOut:function(e)
	{
		this.container.val( this.getFormatedVal());
	},
	hideError: function(v)
	{
		this.container.removeClass("error");
		if (this.inputOpentip)
			this.inputOpentip.deactivate();
	},
	showError: function(v)
	{
		this.container.addClass("error");
		
		if (this.inputOpentip == null)
		{
			Opentip.lastZIndex = 100000;
			this.inputOpentip = new Opentip(this.container, { showOn: 'mouseover', style: 'alert', 'removeElementsOnHide': true });
		}

		this.inputOpentip.setContent(v);
      	this.inputOpentip.activate();
      	this.inputOpentip.show();
	},
	
	isNumberKey: function(evt)
	{
		return isNumberKey(evt);
	},
	_isCharAccepted: function(evt)
	{	
		return true;
	},
	isValid: function()
	{
		var isOk = true;
		var v = this.container.val();

		if (v.trim() == ""){
			if (this.required)
				isOk = "Valeur requise";
		}
		else
		if (!this.mask.test(v)) 
		{
			isOk = "Valeur incorrecte";			
		}
		return isOk;
	},
	_onChange:function(e)
	{	
		var isValid = this.isValid();
	
		if (isValid === true){
			this.hideError();
		}
		else{
			this.showError(isValid);
		}
		var value = this.val();
		if (this._oldValue != value){
			if ((typeof e != "undefined") && ((e.type == 'change') || (e.type == 'keyup')))
				this.dispatchEvent( new Tevent(Tevent.CHANGE, {sender:this, value: value}));
		}
		this._oldValue = value;
	},

	_onShow: function(e)
	{
	},

	getFormatedVal: function()
	{
		var r = this.container.val();
		return r;
	},
	
	val: function(value)
	{
		if (arguments.length == 0)
		{
			return this.getFormatedVal();
		}else
		{
			this.container.val(value);
			setTimeout(this._onChange.bind(this), 500);
		}
	}
});
//]]>
</script>

</head>
</html> 
