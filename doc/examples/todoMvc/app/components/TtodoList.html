<html>        
<head>

<script type="text/x-class-definition">
//<![CDATA[
uses("model.Tmodel");    
defineClass("TtodoList", "core.display.Telement", { 

	baseElement: "div",	
	model: null,
	todos:null,
	enableHashManager : true,
	hashKey: "todolist",
	filter: null,

	constructor: function(args){ 
		this._super.constructor.call(this,args);	
		if (!defined(args.model))
			this.model = new Tmodel();

		this.onHashChange(  this.getHash() );
		this.model.getAll( this.onGetAll.bind(this));
	},
	onHashChange: function(hash){

		if (hash == null){
			this.filter = null;
		}else{
			this.filter = {completed: (hash == "completed")};
		}
		this.filters.getElements("a").each(function(indx, el){
			var h = el.attr("href").rightOf("=");
			if (h == "") h = null;

			if (h == hash)
				el.addClass("selected");
			else
				el.removeClass("selected");
		});
		this.refresh();
	},

	onGetAll: function(data){
		this.todos = data;
		this.todos.on(Tevent.DELETE, this.onItemRemove.bind(this));
		this.todos.on(Tevent.UPDATE, this.onItemUpdate.bind(this));
		this.todos.on(Tevent.ADDED, this.onItemAdded.bind(this));
		this.refresh();
	},

	clear: function(){
		this.todoList.getElements('li[todo-id]').each(function(indx, el){
			el[0].owner.free();
		});
	},

	refresh: function(){
		if (this.todos == null)
			return;
		//Free all items
		this.clear();
		for (var i=0; i< this.todos._source.length; i++)
		{
			var item = this.todos._source[i];
			if (this.filter == null){
				this.addItemCompo( item );
			}else{
				var filterOk = true;
				for (var k in this.filter)
				{
					if (item[k] != this.filter[k]){
						filterOk = false;
						break;
					}					
				}
				if (filterOk)
					this.addItemCompo( item );
			}		
		}
		this.renderTodosLeftCount();
		this.refreshFooter();
	},
	refreshFooter: function(){
		if (this.todos.length == 0)
			this.footer.hide();
		else
			this.footer.show();
	},
	addItemCompo: function(todo, indx){
		var compo = panjs.createComponent("components.TtodoItem.html", { todo: todo, model: this.model});
		compo.container.attr("todo-id", todo.id);
		compo.prependTo(this.todoList);
	},

	getTodoItemCompo: function(id){
		var el = this.todoList.getElement('[todo-id="'+id+'"]');
		if (el)
			return el[0].owner;
		else
			return null;
	},
	renderTodosLeftCount: function(){
		var completedTodos = this.model.getTodosCompleted();
		var notCompletedCount = this.todos.length - completedTodos.length;
		this.toggleAll.prop("checked", (notCompletedCount == 0));	
		this.todoCount.html("<strong>"+notCompletedCount+"</strong> item left");
		this.clearCompleted.text("Clear completed ("+completedTodos.length+")");
		if (completedTodos.length == 0)
			this.clearCompleted.hide();
		else
			this.clearCompleted.show();
	},

	//Events from UI
	onToggleAll: function(e){
		var completed = $(e.target).prop("checked");
		for (var i=0; i< this.todos.length; i++){
			this.todos._source[i].completed = completed;
			this.model.save(this.todos._source[i]);
		}
		this.refresh();
	},

	onNewTodoKeyUp: function(e){
		
		if (e.which === 13 && this.newTodo.val().trim()) {
			this.model.save({body: this.newTodo.val(), completed: false});
			this.newTodo.val('');
		}
	},

	//Events from model		
	onItemAdded: function(e){		
		this.addItemCompo(e.data.item);
		
	},
	onClearCompleted: function(){
		var completedTodos = this.model.getTodosCompleted();
		for (var i=0; i< completedTodos.length; i++)
			this.model.removeById(completedTodos[i].id);
		this.renderTodosLeftCount();
	},
	onItemRemove: function(e){
		var todoItem = this.getTodoItemCompo(e.data.id);
		if (todoItem)
			todoItem.free();
		if (this.todos.length == 0 ){
			this.toggleAll.hide();
			
		}
		else{
			this.toggleAll.show();
		}
		this.renderTodosLeftCount();
		this.refreshFooter();
	},
	onItemUpdate: function(e){
		var compo = this.getTodoItemCompo(e.data.id);
		if (compo)
			compo.render();
		this.refresh();
	}
});

//]]>
</script>

</head>

<body>	
		<section id="todoapp">
			<header id="header">
				<h1>todos</h1>
				<input id="new-todo" placeholder="What needs to be done?" autofocus="autofocus" data-onkeyup="this.onNewTodoKeyUp"/>
			</header>
			<!-- This section should be hidden by default and shown when there are todos -->
			<section id="main">
				<input id="toggle-all" type="checkbox" data-onclick="this.onToggleAll"/>
				<label for="toggle-all">Mark all as complete</label>
				<ul id="todo-list">
					<!-- These are here just to show the structure of the list items -->
					<!-- List items should get the class `editing` when editing and `completed` when marked as completed -->
					
				</ul>
			</section>
			<!-- This footer should hidden by default and shown when there are todos -->
			<footer id="footer">
				<!-- This should be `0 items left` by default -->
				<span id="todo-count"></span>
				<!-- Remove this if you don't implement routing -->
				<ul id="filters">
					<li>
						<a class="selected" href="#">All</a>
					</li>
					<li>
						<a href="#todolist=active">Active</a>
					</li>
					<li>
						<a href="#todolist=completed">Completed</a>
					</li>
				</ul>
				<!-- Hidden if no completed items are left â†“ -->
				<button id="clear-completed" data-onclick="this.onClearCompleted"></button>
			</footer>
		</section>
</body>
</html> 
