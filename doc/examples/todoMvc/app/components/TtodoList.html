<html>        
<head>

<script type="text/x-class-definition">
//<![CDATA[
 
defineClass("TtodoList", "core.display.Telement", { 

	baseElement: "div",	
	model: null,
	todos:null,
	enableHashManager : true,
	hashKey: "todolist", 
	
	constructor: function(args){ 
		this._super.constructor.call(this,args);

		if (defined(args.model))
			this.model = args.model;
		else
			this.model = new Tmodel();

		this.model.filter = this.getHash();
		this.todoList.model = this.model;

		//set click events on footer links
		this.filters.getElements("a").each(function(indx, el){
			var hash = el.attr("href").rightOf("=") || null;
			el.on("click", function(){
				this.setHash(hash);
				return false;
			}.bind(this));
		}.bind(this));

		//We change the id because the todoMvc css applies style on elements with id="todo-list" and not 'todoList'
		this.todoList.container.attr('id', 'todo-list');

		this.model.getAll( this.onGetAll.bind(this));
	},

	filterFunction: function(item){	
		return ( (this.model.filter == null) || ( (this.model.filter  == "active")&& !item.completed ) || ((this.model.filter  == "completed") && item.completed) );
	},

	onHashChange: function(hash){
		//hash = null or 'active' or 'completed'
		this.model.filter = hash;
		this.refreshFooter();
	},

	onGetAll: function(todos){
		this.todos = todos;

		this.todoList.setFilterFunction( this.filterFunction.bind(this) );
		this.todoList.setDataProvider(this.todos);

		this.todos.on(Tevent.CHANGE, this.refreshFooter.bind(this));
		//this.todos.on(Tevent.UPDATE, this.refreshFooter.bind(this));
		//this.todos.on(Tevent.ADDED, this.refreshFooter.bind(this));
		this.refreshFooter();
	},
	
	translateItems: function (num) {
		return num === 1 ? 'item' : 'items';
	},

	refreshFooter: function()
	{
		var notCompletedCount = this.model.getNotCompletedCount();
		var completedCount = this.model.getCompletedCount();

		//header
		this.toggleAll.toggle( this.todos.length > 0 );		
		this.toggleAll.prop("checked", (notCompletedCount == 0));	

		//footer
		this.footer.toggle( this.todos.length > 0 );
		this.todoCount.html("<strong>"+notCompletedCount+"</strong> "+this.translateItems(notCompletedCount)+" left");
		this.clearCompleted.text("Clear completed ("+completedCount+")");			
		this.clearCompleted.toggle( completedCount > 0 );

		//add/remove class 'selected' on footer links
		this.filters.getElements("a").each(function(indx, link){
			var h = link.attr("href").rightOf("=") || null;
			link.toggleClass("selected", (h == this.model.filter));
		}.bind(this));
	},
	
	//Events from UI => update model
	onClearCompleted: function(){		
		this.model.clearCompleted();
	},
	onToggleAll: function(e){
		this.model.toggleAll( $(e.target).prop("checked") );		
	},

	onNewTodoKeyUp: function(e)
	{	
		if (e.which === 13 && this.newTodo.val().trim()) {
			this.model.addNewItem( {body: this.newTodo.val() } );		
			this.newTodo.val('');
		}
	}
});

//]]>
</script>

</head>

<body>	


		<section id="todoapp">
			<header id="header">
				<h1>todos</h1>
				<input id="new-todo" placeholder="What needs to be done?" autofocus="autofocus" data-onkeyup="this.onNewTodoKeyUp"/>
			</header>
			<section id="main">
				<input id="toggle-all" type="checkbox" data-onclick="this.onToggleAll"/>
				<label for="toggle-all">Mark all as complete</label>

				<div id="todoList" data-compo="ui.grids.TlistView.html" data-item-renderer-class="components.TtodoItem.html" />
			
			</section>
			<footer id="footer">
				<span id="todo-count"></span>
				<ul id="filters">
					<li>
						<a class="selected" href="#">All</a>
					</li>
					<li>
						<a href="#todolist=active">Active</a>
					</li>
					<li>
						<a href="#todolist=completed">Completed</a>
					</li>
				</ul>
				<button id="clear-completed" data-onclick="this.onClearCompleted"></button>
			</footer>
		</section>
</body>
</html> 
