<html>        
<head>

<script type="text/x-class-definition">
//<![CDATA[
uses("model.Tmodel");    
defineClass("TtodoList", "core.display.Telement", { 

	baseElement: "div",	
	model: null,
	todos:null,
	enableHashManager : true,
	hashKey: "todolist",
	filter: null,
	hash:null,

	constructor: function(args){ 
		this._super.constructor.call(this,args);	
		if (!defined(args.model))
			this.model = new Tmodel();

		this.hash = this.getHash();

		this.todoList.model = this.model;
		//We change the id because the todoMvc css applies style on elements with id="todo-list" and not 'todoList'
		this.todoList.container.attr('id', 'todo-list');

		this.model.getAll( this.onGetAll.bind(this));
	},

	filterFunction: function(item){	
		return ( (this.hash == null) || ( (this.hash == "active")&& !item.completed ) || ((this.hash == "completed") && item.completed) );
	},

	onHashChange: function(hash){
		this.hash = hash;
		this.render();
	},

	onGetAll: function(todos){
		this.todos = todos;

		this.todoList.setFilterFunction( this.filterFunction.bind(this) );
		this.todoList.setDataProvider(this.todos);

		this.todos.on(Tevent.DELETE, this.refreshInfos.bind(this));
		this.todos.on(Tevent.UPDATE, this.refreshInfos.bind(this));
		this.todos.on(Tevent.ADDED, this.refreshInfos.bind(this));
		this.render();

	},

	render: function(){
		this.todoList.render();
		this.refreshInfos();
	},
	
	translateItems: function (num) {
		return num === 1 ? 'item' : 'items';
	},

	refreshInfos: function()
	{
		this.toggleAll.toggle( this.todos.length > 0 );
		this.footer.toggle( this.todos.length > 0 );

		var notCompletedCount = this.model.getNotCompletedCount();
		this.toggleAll.prop("checked", (notCompletedCount == 0));	

		this.todoCount.html("<strong>"+notCompletedCount+"</strong> "+this.translateItems(notCompletedCount)+" left");
		this.clearCompleted.text("Clear completed ("+this.model.getCompletedCount()+")");			

		this.clearCompleted.toggle( this.model.getCompletedCount() > 0 );

		//add/remove class 'selected' on filters links
		this.filters.getElements("a").each(function(indx, el){
			var h = el.attr("href").rightOf("=") || null;
				el.toggleClass("selected", (h == this.hash));
		}.bind(this));
	},
	
	//Events from UI
	onClearCompleted: function(){		
		this.model.clearCompleted();
	},
	onToggleAll: function(e){
		this.model.toggleAll( $(e.target).prop("checked") );		
	},

	onNewTodoKeyUp: function(e)
	{	
		if (e.which === 13 && this.newTodo.val().trim()) {
			this.model.addNewItem( {body: this.newTodo.val() } );		
			this.newTodo.val('');
		}
	}
});

//]]>
</script>

</head>

<body>	


		<section id="todoapp">
			<header id="header">
				<h1>todos</h1>
				<input id="new-todo" placeholder="What needs to be done?" autofocus="autofocus" data-onkeyup="this.onNewTodoKeyUp"/>
			</header>
			<section id="main">
				<input id="toggle-all" type="checkbox" data-onclick="this.onToggleAll"/>
				<label for="toggle-all">Mark all as complete</label>

				<div id="todoList" data-compo="ui.grids.TlistView.html" data-item-renderer-class="components.TtodoItem.html" />
			
			</section>
			<footer id="footer">
				<span id="todo-count"></span>
				<ul id="filters">
					<li>
						<a class="selected" href="#">All</a>
					</li>
					<li>
						<a href="#todolist=active">Active</a>
					</li>
					<li>
						<a href="#todolist=completed">Completed</a>
					</li>
				</ul>
				<button id="clear-completed" data-onclick="this.onClearCompleted"></button>
			</footer>
		</section>
</body>
</html> 
