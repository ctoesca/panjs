<html>        
<head>

<script src="../../lib/opentip/2.4.6/downloads/opentip-jquery.min.js"></script>
<link href="../../lib/opentip/2.4.6/css/opentip.css" rel="stylesheet" type="text/css" />

<style type="text/less">	

.TmaskInput
{
	vertical-align: middle;
}
.TmaskInput.error{
		color:#c9302c;
		border-color:#c9302c;
		border-width: 1px;
	}
</style>

<script data-subtype="text/x-class-definition">
//<![CDATA[
              
defineClass("TmaskInput", "panjs.core.display.Telement", { 

	/* PROPRIETES */

	baseElement: "input",
	errorText: null,
	mask: null,
	placeholder: "",
	/* METHODES */
	required: false,

	_value: null, 
	inputOpentip: null,

	constructor: function(args){
		
		this._super.constructor.call(this,args);
		
		this.input = this.container;

		if (args)
		{
			this.injectParam("placeholder", args.placeholder,false, this.placeholder);
			if (args.style)
				this.container.attr("style", args.style);
		}
		if (defined(args, "required"))
			this.required = args.required;

		if (defined(args, "size"))
		{
			var size = args.size;
			this.container.attr("size", size);
			this.container.css("width", (size*25)+"px")
			//this.input.attr("maxLength", args.elem.getAttribute("size")); // ne fonctionne que sur input type="text"
		}

		this.container.attr("type","text");
		this.container.addClass("form-control");
		this.container.attr("placeholder", this.placeholder);

		var v = "";
		if (defined(args, "value"))
			v = args.value;
		this.val(v);
		this._setEvents();
	
	},
	free: function(){
		this._super.free.call(this);
		if (this.inputOpentip){
			this.inputOpentip.deactivate();
		}
	},
	enabled: function(v){
		if (v)
			this.container.removeAttr("disabled");
		else
			this.container.attr("disabled","disabled");
		
	},
	_setEvents: function()
	{
		this.container.on("change", this._onChange.bind(this));
		this.container.on("keyup", this._onChange.bind(this));
		this.container.on("keydown", this._onKeyDown.bind(this));
		this.container.on("focusout", this._onFocusOut.bind(this));
	},

	_onKeyDown:function(e)
	{
		if (!this.isCharAccepted(e))
			e.preventDefault();
	},
	_onFocusOut:function(e)
	{logger.error(this.getFormatedVal());
		this.container.val( this.getFormatedVal());
	},
	hideError: function(v)
	{
		this.container.removeClass("error");
		if (this.inputOpentip)
			this.inputOpentip.deactivate();
	},
	showError: function(v)
	{
		this.container.addClass("error");
		
		if (this.inputOpentip == null)
		{
			Opentip.lastZIndex = 100000;
			this.inputOpentip = new Opentip(this.container, { showOn: 'mouseover', style: 'alert', 'removeElementsOnHide': true });
		}

		this.inputOpentip.setContent(v);
      	this.inputOpentip.activate();
      	this.inputOpentip.show();
	},
	
	isNumberKey: function(evt)
	{
		return isNumberKey(evt);
	},
	isCharAccepted: function(evt)
	{	
		return isControlKey(evt);
	},
	isCorrectValue: function()
	{
		var isOk = true;
		var v = this.container.val();

		if (v.trim() == ""){
			if (this.required)
				isOk = "Valeur requise";
		}
		else
		if (!this.mask.test(v)) 
		{
			isOk = "Valeur incorrecte";			
		}

		return isOk;
	},
	_onChange:function(e)
	{	
		var isCorrectValue = this.isCorrectValue();
	
		if (isCorrectValue === true){
			this.hideError();
		}
		else{
			this.showError(isCorrectValue);
		}
		var value = this.val();
		if (this._value != value){
			if ((typeof e != "undefined") && ((e.type == 'change') || (e.type == 'keyup')))
				this.dispatchEvent( new Tevent(Tevent.CHANGE, {sender:this, value: value}));
		}
		this._value = value;
	},

	_onShow: function(e)
	{
	},

	getFormatedVal: function()
	{
		var r = this.container.val();
		return r;
	},
	
	val: function(value)
	{
		if (arguments.length == 0)
		{
			return this.getFormatedVal();
		}else
		{
			this.container.val(value);
			setTimeout(this._onChange.bind(this), 500);
		}
	}
});
//]]>
</script>

</head>
</html> 
