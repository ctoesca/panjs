<html>        
<head>

<style>	
.TtabSelect
{
	
}
.TtabSelect span {
	font-weight: normal;
	letter-spacing: 1px;
	text-decoration: none;
	padding: 2px;
	padding-left: 4px;
	padding-right: 4px;
	padding-bottom: 1px;
	margin-right: 6px;
	
	cursor: hand;
	cursor: pointer;
	
	text-shadow: 0 1px 1px rgba(0,0,0,.3);
	-webkit-border-radius: .2em;
	-moz-border-radius: .2em;
	border-radius: .2em;
	-webkit-box-shadow: 0 1px 2px rgba(160,160,160,1);
	-moz-box-shadow: 0 1px 2px rgba(160,160,160,1);
	box-shadow: 0 1px 2px rgba(160,160,160,1);
}

.TtabSelect span.active {
	background: #99cc33;
	/*color: #fff;*/
	color: #2A2A2A;
	border: 1px #66aa00 solid;
}
.TtabSelect span.active:hover {
	background: #66aa00;
	color: #2A2A2A;
	border: 1px #338800 solid;
}

.TtabSelect span.inactive {
	background: #ddd;
	color: #888;
	border: 1px #bbb solid;
}
.TtabSelect span.inactive:hover {
	background: #bbb;
	color: #2A2A2A;
	border: 1px #888 solid;
}

</style>

<script data-subtype="text/x-class-definition">
//<![CDATA[

uses("panjs.core.collections.TarrayCollection");
             
defineClass("TtabSelect", "panjs.core.display.Telement", { 

	/* PROPRIETES */
	baseElement: "span",	
	_dp: null,
	singleSelection: false,
	canUnselectAll: true,
	elements: null,
	labelField: null,

	/* METHODES */
	constructor: function(args){
		this._super.constructor.call(this,args);
		this.elements = [];

		if (args)
		{
			this.injectParam("singleSelection", args.singleSelection,false);				
			this.injectParam("labelField", args.labelField,false);		
			this.injectParam("canUnselectAll", args.canUnselectAll,false);			
		}
	},
		
	_onInitialized: function()
	{
	},
	
	init: function()
	{
		this.container.html("");
		for (var i=0; i< this._dp._source.length; i++)
		{
			var item = this._dp._source[i];
			var label = this._getLabel(item);
			var el = $('<span class="inactive">'+label+'</span>');
			el.prop("item", item);
			el.on("click", this._onItemClick.bind(this));
			this.container.append(el);
		}
		this.elements = this.container.getElements("span");
	},
	_getLabel: function(item)
	{
		var r = "";
		if (this.labelField)
			r = item[this.labelField];
		else
			r = item;

		return r;
	},
	_onItemClick: function(e){
		var el = $(e.target);
		var item = el.prop("item");
		
		var evt = new Tevent(Tevent.ITEM_CLICKED, item);
		this.dispatchEvent(evt);		
		if (evt.defaultPrevented)
			return false;
		this.setItemState(item, !el.hasClass("active"));
	},

	_setElementState: function(el, active){
		el.toggleClass("active", active);
		el.toggleClass("inactive", !active);
	},
	_setAllElementsState: function(selected){
		for (var i=0; i< this.elements.length; i++){
			this._setElementState(this.elements[i], selected);
		}
	},
	getElementFromItem: function(item){
		var r = null;
		for (var i=0; i< this.elements.length; i++){
			var el = this.elements[i];
			var it = el.prop("item");
			if (it == item){
				r = el;
				break;
			}
		}
		return r;
	},

	count: function(){
		var r = 0
		if (this._dp!= null) 
			r = this._dp.length;
		return r;
	},
	selectAll: function(){
		if ((this.singleSelection)&& (this.count() > 0))
			throw "Only one item can be selected (singleSelection=true)"
		this._setAllElementsState(true);
	},
	unselectAll: function(){
		this._setAllElementsState(false);
	},
	setItemState: function(item, active, sendEvents){
		if (arguments.length < 3)
			var sendEvents = true;

		var el = this.getElementFromItem(item);
		var changed = false;
		if (el != null)
		{
			var selElements = this.getSelectedElements();
			if (this.singleSelection)
			{	
				if (selElements.length == 1)
				{
					var selectedElem = selElements[0];
					if (selElements[0].prop("item") == item)
					{
						if ((active == false)&& (this.canUnselectAll==true))
						{
							//désactivation de la seul item active
							this._setElementState(el, false);
							changed = true;
						}
					}else
					{
						if (active)
						{
							//1 autre item est active, activation de cette item
							this._setElementState(selectedElem, false);
							this._setElementState(el, active);
							changed = true;	
						}else{
							//1 autre item est active, désactivation de cette item
							if (this.canUnselectAll==true){
								this._setElementState(selectedElem, false);
							}
						}
					}

				}else{
					//modif etat autre item					
					this._setAllElementsState(false);
					this._setElementState(el, active);
					changed = true;
				}

			}else
			{
				if ((selElements.length == 1) && (active==false) && (selElements[0].prop("item") == item))
				{
					//Désactivation dernière item active
					if (this.canUnselectAll==true){
						this._setElementState(el, active);
						changed = true;	
					}
				}
				
			}
		}	
		if (changed && sendEvents){
			var evt = new Tevent(Tevent.CHANGE, this.getSelectedItems());
			this.dispatchEvent(evt);
		}
		return changed;
	},

	setDataProvider: function(dp)
    {
        this._dp = dp;
        this.init();
    },
	getDataProvider: function()
	{
		return this._dp;
	},
	getSelectedElements:function(){
		return this.container.getElements("span.active");
	},
	getSelectedItems:function()
	{
		var r = [];
		var selectedEl = this.container.getElements("span.active");
		for (var i=0; i< selectedEl.length; i++){
			var item = selectedEl[i].prop("item");
			r.push(item);
		}
		return r;
	},
	setSelectedItems:function(items)
	{

		if (!Array.isArray(items))
			items = [items];

		var changed = false;
		for (var i=0; i< items.length; i++)
		changed = changed || this.setItemState(items[i], true, false);	
	
		if (changed){
			var evt = new Tevent(Tevent.CHANGE, this.getSelectedItems());
			this.dispatchEvent(evt);
		}
		
	}	

});

//]]>
</script>

</head>

<body>	 



</body>
</html>

