<html>        
<head>
<link href="TpopupManager.css" type="text/css"></link>

<script type="text/x-class-definition">
//<![CDATA[
defineClass("TpopupManager", "core.events.TeventDispatcher", { 

	popups: null,
	mask: null,
	maskIsVisible: false,
	winH: null,
	winW: null,
	allowScroll: true,

	constructor: function(args){
		this._super.constructor.call(this,args);		

		this.popups = [];

		$(window).resize(function () {
	        if (this.popups.length ==0)	return;
               
	        this.winH = $(window).height();
	        this.winW = window.innerWidth;

			this._refreshMaskSize();  

			//centrage des modales ouvertes
	        for (var i=0; i<this.popups.length; i++)
	        	this._positionnerModal( this.popups[i].window );
	        
		}.bind(this));

	},

	addPopup: function(instance, options)
	{		
		
		
		var ctn = $('<div class="window TpopupManager" ></div>');
		ctn.on("click", function(e){
			if ( $(e.target).hasClass("window"))
				this._onMaskClick(e);
		}.bind(this));

		ctn.append(instance.container);
		
		var obj = {
			window: ctn, 
			compo: instance, 
			closeOnMaskClick: false,
			freeOnClose: true
		};

		if (defined(options, "closeOnMaskClick"))
			obj.closeOnMaskClick = options.closeOnMaskClick;
		if (defined(options, "freeOnClose"))
			obj.freeOnClose = options.freeOnClose;
		if (defined(options, "allowScroll"))
				this.allowScroll = options.allowScroll;

	
		instance.on(Tevent.CLOSE, this._onCompoClose, null ,this);
	
		this.popups.push( obj );

		

		$(document.body).append(ctn);
		this._positionnerModal(ctn);
		ctn.show();

		if (this.allowScroll == false){
			$(document.body).css("overflow-y", "hidden");
			$(document.body).css("overflow-x", "hidden");
		}
        //ctn.fadeIn(500); 

		this.dispatchEvent(new Tevent(Tevent.SHOW, instance));	
		//$(document.body).css("overflow-y", "hidden");
		
		this._showMask();
		return instance;
	},
	createPopup: function(className, args , options )
	{		
		if (defined(args)){
			if (typeof className == "string")
				var compo = panjs.createComponent(className,args); 
			else
				var compo = new className(args); 

		
		}
		else{
			if (typeof className == "string")
				var compo = panjs.createComponent(className); 
			else
				var compo = new className();
		}

		this.addPopup(compo, options);
		return compo;
	},
	removePopup: function(compo)
	{
		for (var i=0; i< this.popups.length; i++)
		{
			if (this.popups[i].compo == compo)
			{
				if (this.allowScroll == false){
					$(document.body).css("overflow-y", "auto");
					$(document.body).css("overflow-x", "auto");
				}

				var freeOnClose = this.popups[i].freeOnClose;

				this.popups[i].window.detach();

				compo.off(Tevent.CLOSE, this._onCompoClose);
			
				this.popups.splice(i,1);	
					
				if (this._getLastModal() == null)
					this._hideMask();
								
				this.dispatchEvent(new Tevent(Tevent.CLOSE, compo));
				if ((typeof compo.free == "function")&&( freeOnClose == true))
					compo.free();
					
				break;
			}
		}
	},

	_hideMask: function()
	{   
		if ((panjs.iever == -1) ||(panjs.iever >= 10))
		{
			this.mask.fadeTo("fast",0, function(e){
        	this.mask.css("display", "none");
        	if (this.maskIsVisible)
        		this._showMask();
       		}.bind(this));
		}else
		{
			this.mask.hide();
			this.mask.css("opacity", "0"); 
		}
        
        this.maskIsVisible = false;
	},
	_showMask: function()
	{
		if (this.mask == null){
			this.mask =  $('<div class="mask TpopupManager" style="display:none"></div>');
			$(document.body).append( this.mask);
			this.mask.on("click", this._onMaskClick.bind(this)); 
		}

		this._refreshMaskSize();  
		if ((panjs.iever == -1) ||(panjs.iever >= 10)){
        	this.mask.fadeTo("fast",0.8,function(e){}); 
		}
    	else{
			this.mask.css("opacity", "0.8"); 
			this.mask.show();
    	}
        this.maskIsVisible = true;
	},
	_positionnerModal: function(ctn)
	{
		if (this.winH == null){
			this.winH = $(window).height();
        	this.winW = window.innerWidth;//$(window).width();
        }
        var top = $(window).scrollTop();
        if (top<0)
        	top=0;

        /*var left = (this.winW-ctn.width())/2;*/
		var left = 0;

        ctn.css('top', top );
        ctn.css('left',left);
	},
	_refreshMaskSize: function()
	{
		if (this.mask == null) return;
		var maskHeight = $(document).height();
        var maskWidth = $(window).width();     	
        this.mask.css({'width':maskWidth,'height':maskHeight});  
	},
	_onMaskClick: function()
	{
		//Fermeture de la derniÃ¨re modale si closeOnMaskClick=true
		var lastModal = this._getLastModal();
		if ((lastModal!=null) && (lastModal.closeOnMaskClick))
			this.removePopup(lastModal.compo);
	},
	
	_onCompoClose: function(e)
	{
		//$(document.body).css("overflow-y", "auto");
		this.removePopup(e.currentTarget);

	},

	_getLastModal: function()
	{
		var r = null;
		if (this.popups.length > 0)
			r = this.popups[this.popups.length-1];
		return r;
	}
	
});

panjs.PopupManager = new TpopupManager();

//]]>
</script>
</head>
</html>
