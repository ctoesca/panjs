<html>        
<head>

<link href="./bootstrap-combobox-master/css/bootstrap-combobox.css" rel="stylesheet"/>
<script type="text/javascript" src="./bootstrap-combobox-master/js/bootstrap-combobox.js"></script>

<style type="text/less">
.TsearchCombobox
{
    .input-append .btn.dropdown-toggle {
        float: none;
    }
}
</style>

<script type="text/x-class-definition">
//<![CDATA[

uses("core.collections.TarrayCollection");
             
defineClass("TsearchCombobox", "core.display.Telement", { 

    baseElement:"div",
    labelField: null,
    valueField:null,

    placeholder: "",
    _dataProvider: null,
    _combo: null,
    selectingItem: null,
    selectedItem:null,

    _sendChangeEvent: true,

    constructor: function(args){
        this._super.constructor.call(this,args); 
        
        if (defined(args, "placeholder"))
            this.placeholder = args.placeholder;

        if (defined(args, "valuefield"))
            this.valueField = args.valuefield;
        
        if (this.valueField == null)
            this.valueField = this.labelField;

        this.waitingIcon = $('<i class="fa fa-spinner fa-2x fa-spin" id="waitingIcon" style="font-size:0.8em;color:#0099CC;"></i>');
        this.container.append(this.waitingIcon);
    },

    getDataProvider: function(dp)
    {
        return this._dataProvider;
    },
    setDataProvider: function(dp)
    {
        var dataProviderWasNull = (this._dataProvider == null);
        this._dataProvider = dp;
        this._populate();
        this._combo.clearTarget();
        this._combo.clearElement();
        this._combo.refresh();

        if ((this.selectingItem != null)&& (dataProviderWasNull == true))
            this.val(this.selectingItem);
        this.selectingItem = null;
    },
    
    refresh: function(){
        this.setDataProvider(this._dataProvider);
    },
    _populate: function()
    {
        this.select.html("");
        //var el = this.container.getElement("div.input-group");

        if (this._dataProvider != null)
        {
            for (var i = 0; i< this._dataProvider.length; i++){

                this._addItem(this._dataProvider._source[i]);
            }
        }
        this.waitingIcon.hide();
        this._combo = this.select.combobox().data('combobox') ;
         this.container.getElement('input.combobox').attr('placeholder', this.placeholder);
        this._combo.$source.on("change", this.onChange.bind(this));
        
    },
  
    onChange: function(e)
    {
        var v = $(e.target).val();
     
        if (v != null)
            v = this._dataProvider.getByProp(this.valueField, v);
      
        var oldSelectedItem = this.selectedItem;
        this.selectedItem = v;

        if ((oldSelectedItem != v)&&(this._sendChangeEvent)){
            this.dispatchEvent( new Tevent(Tevent.CHANGE, v));
        }     
    },
    labelFunction: function(item){
        return item[this.labelField];
    },
    _addItem: function(item)
    {
        if (item == null)
        {
            var s = $('<option value=""></options>');
        }else
        {
            var s = $('<option value="'+item[this.valueField]+'">'+this.labelFunction(item)+'</options>');
            //s[0].data = item;
            //s.data(item);
        }
        this.select.append(s);
    },
    setErrorText: function(v){
        this.container.html('<div class="alert alert-danger" role="alert" style="font-size:0.9em">'+v+'</div>');
    }, 
   _getOutputVal: function(item){
        return item;
    },

    _getInputVal: function(item){
        return item;
    },

    val: function(item)
    {
        if (arguments.length == 0)
        {
            /*var label = this._combo.getValue();
            if (label.trim() == "")
                return null;*/
            
            var r = null;   
            if (this._dataProvider != null) {
                //r = this._dataProvider.getByProp(this.labelField, label);
                r = this.selectedItem;    
            }
            
            return this._getOutputVal(r);
        }
        else
        {
            if (this._dataProvider != null)
            {    
                item = this._getInputVal(item);    
                if (item != null){
                    this._combo.select(this.labelFunction(item));
                     this.selectedItem = item;
                }
                else{
                    this._combo.select(null);
                     this.selectedItem = null;
                }            
            }
            else
            {
                this.selectingItem = item;
            }
        }
    }
});

//]]>
</script>
</head>
<body>
<select class="combobox form-control" id="select"  style="display:none">
</select>
</body>
</html>