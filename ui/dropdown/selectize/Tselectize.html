<html>        
<head>

  <link href="/libs/selectize/0.12.1/dist/css/selectize.bootstrap3.css" rel="stylesheet"/>

  <script type="text/javascript" src="/libs/selectize/0.12.1/dist/js/standalone/selectize.min.js"></script>

<style>
.Tselectize .selectize-dropdown .optgroup {
	border-style:none;
}
.Tselectize .selectize-dropdown-content {
  max-height: 300px;
}
</style>
<script subtype="text/x-class-definition">
//<![CDATA[
              
defineClass("Tselectize", "core.display.Telement", { 
	/* PROPRIETES */
	baseElement: "select",
	
	/* ARGS */	
	valueField: "id",
	labelField: "text",
	searchField: null,
	sortField: null,
	placeholder: "",
	maxItems: 1000,
	width: null,
	renderItem: null,
	renderOption: null,
	theme: "bootstrap3",

	/* PRIVATE */
	_data: null,
	_control:null,
	_dataProvider: null,
	_data: null,
	_postCreateActions: null,

	constructor: function(args){
		
		this._super.constructor.call(this,args);
		this._postCreateActions = [];

		this.injectParam("width", args["width"],false);
		this.injectParam("placeholder", args["placeholder"],false);
		this.injectParam("valueField", args["valueField"],false);
		this.injectParam("labelField", args["labelField"],false);
		this.injectParam("searchField", args["searchField"],false);
		this.injectParam("sortField", args["sortField"],false);
		this.injectParam("theme", args["theme"],false);
		this.injectParam("maxItems", args["maxItems"],false);
		
		panjs.loader.loadCssFile("/libs/selectize/0.12.1/dist/css/selectize."+this.theme+".css");

		if (this.searchField == null)
			this.searchField = this.labelField;
		if (this.sortField == null)
			this.sortField = this.labelField;
		if (this.width != null)
			this.container.attr("width", this.width);

     	this.setPlaceholder(this.placeholder);

	},
	setPlaceholder: function(v){
		this.container.attr("placeholder",v);
		if (this._control != null)
     		this._control.$control_input.attr("placeholder", v);
	},
	_transformItem: function(item){
		return  item;//{id: item[this.valueField], nom: '<img src="/libs/icons/24/iconVmware.png"/>'+item[this.labelField] , isVm: item.isVm};
	},
	_setIsLoading: function(v){
		//!! A REVOIR
		if (v){	
				this._createComponent([]);		
				this.setPlaceholder("Chargement en cours");
				this._control.$control.append( $('<i class="fa fa-spin fa-cog"></i>') );
		}
		else{
				if (this._control != null){
					var i = this._control.$control.getElement('i');
					if (i) i.remove();
					this.setPlaceholder(this.placeholder);
				}
		}
	},
	setIsLoading: function(v){
		//!! A REVOIR
		//affichage du composant pour pouvoir afficher l'icone de chargement
		//setDataProvider() détruit et recrée le composant = setIsLoading(false)
		if (this._control == null)
		setTimeout(function(){
			this._setIsLoading(v);
		}.bind(this), 0);	
		else
			this._setIsLoading(v);
	},
	setDataProvider: function(dp)
	{	
		this._dataProvider = dp;
		this._data = [];
		for (var i=0; i< this._dataProvider._items.length; i++)
			this._data.push(  this._transformItem( this._dataProvider._items[i] ) );
		this.refresh();		
	},

	_onAfterCreateComponent: function(){

		for (var i=0; i< this._postCreateActions.length; i++)
			this._postCreateActions[i].callback();
		
		this._postCreateActions = [];
	},
	refresh: function() {	
		//this._control.refreshOptions();
		//this._control.refreshItems();
		this._createComponent(this._data);	
	},
	_createComponent: function(data)
	{
		var opt = this._getOptions();
		opt.options = data;

		if (this._control != null)
			this._control.destroy();

		this._control = this.container.selectize(opt)[0].selectize;
		this.setPlaceholder(this.placeholder);
		this._onAfterCreateComponent();

		return this._control;	
	},

	_getOptions: function(){
		var render ={};

		return 	{
					plugins: ['remove_button'],
					maxItems: this.maxItems,
					valueField: this.valueField,
					labelField: this.labelField,
					searchField: this.searchField,
					sortField: this.sortField,
					create: false,
					openOnFocus: true,
					maxOptions: 1000,
					hideSelected: true,
					closeAfterSelect: false,
					allowEmptyOption:false,
					scrollDuration: 60,
					dropdownParent: null,
					onDropdownOpen: this._onOpen.bind(this),
					onDropdownClose: this._onClose.bind(this),
					onChange: this._onChanged.bind(this),
					render: {
						
					}
		};
	},

	
	getSelectedValues:function(propname){
		if (arguments.length<1)
			var propname = this.valueField;

		var items = this.getSelectedItems();
		var r = [];
		for (var i=0; i< items.length; i++)
			r.push(items[i][propname]);
		return r;
	},

	setSelectedValues:function(values, propname, silent)
	{
		if ((this._control != null))
		{
			var items = [];
			if (arguments.length<2)
				var propname = this.valueField;

			for (var i=0; i<values.length; i++)
			{
	 			var item = this._dataProvider.getByProp(propname, values[i]);
	 			if (item != null)
					items.push( item[this.valueField] );
			}
			this._control.setValue( items, silent);	
		}
		else{
			this._postCreateActions.push({ callback: this.setSelectedValues.bind(this, values, propname, silent)});
		}

	},
	addSelectedValues: function(values, propname, silent){
		if ((this._control != null))
		{
			var items = [];
			if (arguments.length<2)
				var propname = this.valueField;

			for (var i=0; i<values.length; i++)
			{
	 			var item = this._dataProvider.getByProp(propname, values[i]);
	 			if (item != null)
	 				this._control.addItem(item[this.valueField], silent);
			}
		}
		else{
			this._postCreateActions.push( { callback: this.addSelectedValues.bind(this, values, propname, silent)} );
		}
	},
	getSelectedItems: function()
	{		
		var selId = this._control.getValue();	
		var r = [];

		if (selId != null)
		for (var i=0; i<selId.length; i++){
			r.push( this._dataProvider.getByProp(this.valueField, selId[i]));
		}
		return r;
	},

	setSelectedItems: function(arr, silent)
	{
		if ((this._control != null))
		{
			var items = [];
			for (var i=0; i<arr.length; i++)
			{
				if ( arr[i] != null){
					items.push( arr[i][this.valueField] );
				}
			}
			this._control.setValue( items, silent);	

		}else{
			this._postCreateActions.push( { callback: this.setSelectedItems.bind(this, arr, silent)} );
		}
	},
	
	_onOpen: function(e)
	{
		if (this.opened == false)
		this.dispatchEvent( new Tevent(Tevent.OPEN));
		this.opened = true;
	},
	_onClose: function(e)
	{
		if (this.opened == true)
		this.dispatchEvent( new Tevent(Tevent.CLOSE));
		this.opened = false;
	},
	_onChanged: function(e, data)
	{
		var data = this.getSelectedItems();
		this.dispatchEvent( new Tevent(Tevent.CHANGE, data));
	},
	
	enabled: function(value){
		if (arguments.length >0)
		{
			this._enabled = value;
			if (value)
				this._control.enable(value);
			else
				this._control.disable(value);
		}
		else{
			return this._enabled;
		}
	},
	show: function(){
		if (this._control != null)
		this._control.$control.show();
	},
	hide: function(){
		if (this._control != null)
		this._control.$control.hide();
	},
	free: function(){
		this._super.free.call(this);
		this._control.destroy();
	}
});
//]]>
</script>

</head>
</html> 

